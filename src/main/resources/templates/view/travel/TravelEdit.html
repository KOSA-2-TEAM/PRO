<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Album Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(to right, #8e44ad, #3498db);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }

        .upload-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            margin: 20px;
            animation: fadeIn 1s ease-in-out;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
        }

        .tag {
            display: inline-block;
            padding: 5px;
            margin: 2px;
            background-color: #e0e0e0;
            border-radius: 3px;
            cursor: default;
        }

        .tag-close {
            margin-left: 5px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .radio-inline {
            display: inline-block;
            margin-right: 10px;
        }
    </style>

    <script src="https://cdn.tiny.cloud/1/ajckn3vmt9uxztu8lb8qylzs2i0zmacodhm03vttrtcs1q88/tinymce/5/tinymce.min.js"
            referrerpolicy="origin"></script>
    <script>
        tinymce.init({
            selector: '#content',
            plugins: 'image code media link',
            toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | image media link code',
            automatic_uploads: true,
            images_upload_handler: function (blobInfo, success, failure) {
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/travel/upload-image');
                xhr.onload = function () {
                    if (xhr.status !== 200) {
                        failure('HTTP Error: ' + xhr.status);
                        return;
                    }

                    let json = JSON.parse(xhr.responseText);
                    if (!json || typeof json.location != 'string') {
                        failure('Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    success(json.location);
                };
                xhr.onerror = function () {
                    failure('XHR Error: ' + xhr.status);
                };

                let formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());
                xhr.send(formData);
            }
        });
        
    </script>

	<script>
	    document.addEventListener('DOMContentLoaded', function () {
	        updateHiddenFields();

	        const existingThemes = document.querySelectorAll('#tagContainer .tag');
	        existingThemes.forEach(function (tag) {
	            const closeBtn = document.createElement('span');
	            closeBtn.className = 'tag-close';
	            closeBtn.textContent = ' x';
	            closeBtn.onclick = function () {
	                tag.remove();
	                updateHiddenFields();
	            };
	            tag.appendChild(closeBtn);
	        });

	        updateHiddenFields();
	    });

	    function addTag() {
	        const input = document.getElementById('themeInput');
	        let tagValue = input.value.trim();

	        if (tagValue && !document.getElementById(tagValue)) {
	            const tag = document.createElement('span');
	            tag.className = 'tag';
	            tag.id = tagValue;
	            tag.textContent = tagValue;

	            const closeBtn = document.createElement('span');
	            closeBtn.className = 'tag-close';
	            closeBtn.textContent = ' x';
	            closeBtn.onclick = function () {
	                document.getElementById('tagContainer').removeChild(tag);
	                updateHiddenFields();
	            };

	            tag.appendChild(closeBtn);
	            document.getElementById('tagContainer').appendChild(tag);
	            input.value = '';
	            updateHiddenFields();
	        }
	    }

	    function updateHiddenFields() {
	        const tags = document.querySelectorAll('#tagContainer .tag');
	        const hiddenFieldsContainer = document.getElementById('hiddenFieldsContainer');
	        hiddenFieldsContainer.innerHTML = ''; 

	        tags.forEach((tag, index) => {
	            const input = document.createElement('input');
	            input.type = 'hidden';
	            input.name = `travelThemeList[${index}].name`;
	            input.value = tag.id;
	            hiddenFieldsContainer.appendChild(input);
	        });
	    }

	    document.getElementById('themeInput').addEventListener('keydown', function (event) {
	        if (event.key === ' ') {
	            event.preventDefault();
	            addTag();
	        }
	    });
	</script>

</head>
<body>
<div class="upload-container">
    <h1>여행앨범 수정하기</h1>
    <form th:action="@{/api/travel/update/{travelIdx}(travelIdx=${response.id})}" 
      method="post" 
      enctype="multipart/form-data">
        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" id="title" name="title" th:value="${response.title}" class="form-control" required/>
        </div>

        <div class="mb-3">
            <label for="region" class="form-label">지역</label>
			<select id="region" name="region" class="form-select" required>
				<option value="서울" th:selected="${response.region == '서울'}">서울</option>
				<option value="인천" th:selected="${response.region == '인천'}">인천</option>
				<option value="부산" th:selected="${response.region == '부산'}">부산</option>
				<option value="대구" th:selected="${response.region == '대구'}">대구</option>
				<option value="광주" th:selected="${response.region == '광주'}">광주</option>
				<option value="대전" th:selected="${response.region == '대전'}">대전</option>
				<option value="울산" th:selected="${response.region == '울산'}">울산</option>
				<option value="세종" th:selected="${response.region == '세종'}">세종</option>
				<option value="경기도" th:selected="${response.region == '경기도'}">경기도</option>
				<option value="강원도" th:selected="${response.region == '강원도'}">강원도</option>
				<option value="총청도" th:selected="${response.region == '총청도'}">총청도</option>
				<option value="전라도" th:selected="${response.region == '전라도'}">전라도</option>
				<option value="경상도" th:selected="${response.region == '경상도'}">경상도</option>
				<option value="제주도" th:selected="${response.region == '제주도'}">제주도</option>
			</select>

			</div>

        <div class="mb-3">
            <label for="statDate" class="form-label">여행시작일</label>
            <input type="date" id="statDate" name="statDate" th:value="${startDate}" class="form-control" required/>
        </div>

        <div class="mb-3">
            <label for="endDate" class="form-label">여행종료일</label>
            <input type="date" id="endDate" name="endDate" th:value="${endDAte}" class="form-control" required/>
        </div>
        
		<div class="mb-3">
			<label for="thumbnail" class="form-label">대표사진</label>
			<div class="thumbnail-preview">
				<img th:src="@{${response.thumbnail}}" alt="대표사진"
					id="thumbnailImage" style="max-width: 200px;">
			</div>
			<label for="thumbnail" class="form-label mt-2">이미지 업로드 입력</label>
			<input type="file" id="thumbnail" name="thumbnail"
				class="form-control" accept="image/*">
		</div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea th:text="${response.getContent()}" id="content" name="content" class="form-control" rows="10"></textarea>
        </div>

		<div class="mb-3">
			<label for="isPublic" class="form-label">공개여부</label>
			<div class="radio-inline">
				<input type="radio" id="public" name="isPublic" value="1"
					th:checked="${response.isPublic == 1}" required /> <label
					for="public">공개</label>
			</div>
			<div class="radio-inline">
				<input type="radio" id="private" name="isPublic" value="0"
					th:checked="${response.isPublic == 0}" required /> <label
					for="private">비공개</label>
			</div>
		</div>

			<div class="mb-3">
				<label for="themeInput" class="form-label">테마</label> <input
					type="text" id="themeInput" class="form-control"
					onkeydown="if(event.code === 'Space') { event.preventDefault(); addTag(); }"
					placeholder="Enter theme and press Space" />
				<div id="tagContainer" class="mt-2">
					<div th:each="theme : ${response.travelThemeList}">
						<span class="tag" th:id="${theme.name}" th:text="${theme.name}">
							<span class="tag-close"
							onclick="this.parentElement.remove(); updateHiddenFields();">
								x</span>
						</span>
					</div>
				</div>
			</div>

			<div id="hiddenFieldsContainer"></div>

			<button type="submit" class="btn btn-primary">수정완료</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
