<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Album Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        html, body {
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        body {
            width: 100%;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: 650px;
            width: 100%;
            max-width: 420px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }

        .main-section {
            background-color: #ffffff;
            width: 100%;
            max-width: 420px;
            height: 650px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            overflow: auto;
            padding: 40px 20px;
            box-sizing: border-box;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            color: #007bff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .back-btn:hover {
            color: #0056b3;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            color: #333;
        }

        .form-control {
            border-radius: 8px;
            padding: 10px;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            margin-top: 15px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 12px rgba(0, 91, 187, 0.3);
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview {
            width: calc(33.33% - 10px); /* 이미지 3개를 한 줄에 맞추기 위해서 계산된 값 */
            height: auto;
        }

        .tag {
            display: inline-block;
            padding: 5px;
            margin: 2px;
            background-color: #e0e0e0;
            border-radius: 3px;
        }

        .tag-close {
            margin-left: 5px;
            cursor: pointer;
        }

        .radio-inline {
            display: inline-block;
            margin-right: 10px;
        }

        .mce-content-body img {
            max-width: 100%; /* 에디터 컨테이너의 너비를 기준으로 최대 너비를 설정 */
            height: auto; /* 비율 유지 */
        }
    </style>

    <script src="https://cdn.tiny.cloud/1/ajckn3vmt9uxztu8lb8qylzs2i0zmacodhm03vttrtcs1q88/tinymce/5/tinymce.min.js"
            referrerpolicy="origin"></script>

    <script>
        tinymce.init({
            selector: '#content',
            plugins: 'image code media link',
            toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | image media link code',
            automatic_uploads: true,
            image_dimensions: false,
            images_upload_handler: function (blobInfo, success, failure) {
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/travel/upload-image');
                xhr.onload = function () {
                    if (xhr.status !== 200) {
                        failure('HTTP Error: ' + xhr.status);
                        return;
                    }

                    let json = JSON.parse(xhr.responseText);
                    if (!json || typeof json.location != 'string') {
                        failure('Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    success(json.location);
                };
                xhr.onerror = function () {
                    failure('XHR Error: ' + xhr.status);
                };

                let formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                // 이미지 크기 조정
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // 원하는 크기로 조정
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(function(blob) {
                            formData.set('file', blob, blobInfo.filename());
                            xhr.send(formData);
                        }, blobInfo.blob().type);
                    };
                };
                reader.readAsDataURL(blobInfo.blob());
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('thumbnail').addEventListener('change', previewImages);
            document.querySelector('form').addEventListener('submit', function (event) {
                tinymce.get('content').save();

                const title = document.getElementById('title').value.trim();
                const region = document.getElementById('region').value.trim();
                const statDate = document.getElementById('statDate').value.trim();
                const endDate = document.getElementById('endDate').value.trim();
                const content = document.getElementById('content').value.trim();
                const thumbnail = document.getElementById('thumbnail').files.length > 0;
                const isPublic = document.querySelector('input[name="isPublic"]:checked');

                if (!title || !region || !statDate || !endDate || !thumbnail || !isPublic || !content) {
                    alert('모든 필드를 올바르게 입력해 주세요.');
                    event.preventDefault();
                } else {
                    const isPublicValue = isPublic.value === 'true' ? 1 : 0;
                    document.querySelector('input[name="isPublic"]').value = isPublicValue;
                }
            });
        });

        function previewImages() {
            const imageContainer = document.getElementById('imageContainer');
            imageContainer.innerHTML = ''; // 기존 이미지 제거

            const files = document.getElementById('thumbnail').files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-preview';
                    imageContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    </script>

    <script>
        function validateEndDate() {
            const startDate = document.getElementById('statDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate && new Date(endDate) < new Date(startDate)) {
                alert("여행 종료일은 시작일보다 빠를 수 없습니다!");
                document.getElementById('endDate').value = ''; // 종료일 필드를 비웁니다.
            }
        }

        function addTag() {
            const input = document.getElementById('themeInput');
            const tagValue = input.value.trim();

            if (tagValue && !document.getElementById(tagValue)) {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.id = tagValue;
                tag.textContent = tagValue;

                const closeBtn = document.createElement('span');
                closeBtn.className = 'tag-close';
                closeBtn.textContent = 'x';
                closeBtn.onclick = function () {
                    document.getElementById('tagContainer').removeChild(tag);
                    updateHiddenFields();
                };

                tag.appendChild(closeBtn);
                document.getElementById('tagContainer').appendChild(tag);
                input.value = null;
                updateHiddenFields();
            }
        }

        function updateHiddenFields() {
            const tags = document.querySelectorAll('#tagContainer .tag');
            const hiddenFieldsContainer = document.getElementById('hiddenFieldsContainer');
            hiddenFieldsContainer.innerHTML = '';

            tags.forEach((tag, index) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `travelThemeList[${index}].name`;
                input.value = tag.id;
                hiddenFieldsContainer.appendChild(input);
            });
        }

        document.getElementById('themeInput').addEventListener('keydown', function (event) {
            if (event.key === ' ') {
                event.preventDefault();
                addTag();
            }
        });
    </script>
</head>
<body>
<div class="page-wrapper">
    <div class="main-section">
        <button class="back-btn" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>여행 앨범 업로드</h1>

        <form th:action="@{/api/travel/create}" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="title" class="form-label">앨범 제목</label>
                <input type="text" class="form-control" id="title" name="title" required>
            </div>

            <div class="mb-3">
                <label for="region" class="form-label">지역</label>
                <select id="region" name="region" class="form-select" required>
                    <option value="서울">서울</option>
                    <option value="인천">인천</option>
                    <option value="부산">부산</option>
                    <option value="대구">대구</option>
                    <option value="광주">광주</option>
                    <option value="대전">대전</option>
                    <option value="울산">울산</option>
                    <option value="세종">세종</option>
                    <option value="경기도">경기도</option>
                    <option value="강원도">강원도</option>
                    <option value="충청도">충청도</option>
                    <option value="전라도">전라도</option>
                    <option value="경상도">경상도</option>
                    <option value="제주도">제주도</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="statDate" class="form-label">여행 시작일</label>
                <input type="date" class="form-control" id="statDate" name="statDate" required>
            </div>

            <div class="mb-3">
                <label for="endDate" class="form-label">여행 종료일</label>
                <input type="date" class="form-control" id="endDate" name="endDate" required
                       onchange="validateEndDate()">
            </div>

            <div class="mb-3">
                <label for="thumbnail" class="form-label">대표사진</label>
                <input type="file" id="thumbnail" name="thumbnail" class="form-control" accept="image/*" required/>
            </div>

            <!--            <div id="imageContainer" class="image-container"></div>-->

            <div class="mb-3">
                <label for="content" class="form-label">여행 내용</label>
                <textarea id="content" class="form-control" name="content"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">공개 여부</label>
                <div>
                    <label class="radio-inline">
                        <input type="radio" name="isPublic" value="true" required> 공개
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="isPublic" value="false"> 비공개
                    </label>
                </div>
            </div>

            <div class="mb-3">
                <label for="themeInput" class="form-label">테마</label>
                <input type="text" id="themeInput" class="form-control"
                       onkeydown="if(event.code === 'Space') { event.preventDefault(); addTag(); }"
                       placeholder="Enter theme and press Space"/>
                <div id="tagContainer" class="mt-2"></div>
            </div>
            <div id="hiddenFieldsContainer"></div>

            <button type="submit" class="btn btn-primary">앨범 업로드</button>
        </form>
    </div>
</div>
</body>
</html>